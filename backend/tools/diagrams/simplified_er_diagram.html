<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½ç©¿æ­åŠ©æ‰‹æ•°æ®åº“ERå›¾</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .header {
            background-color: #333;
            color: white;
            padding: 10px 20px;
            text-align: center;
        }
        .toolbar {
            background-color: #f0f0f0;
            padding: 10px;
            display: flex;
            justify-content: space-between;
        }
        .content {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        #canvas-container {
            width: 100%;
            height: 100%;
            overflow: auto;
            position: relative;
            background-color: white;
            background-image: linear-gradient(#eee 1px, transparent 1px),
                              linear-gradient(90deg, #eee 1px, transparent 1px);
            background-size: 20px 20px;
        }
        #er-canvas {
            position: absolute;
            transform-origin: 0 0;
        }
        .entity {
            position: absolute;
            width: 220px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            overflow: hidden;
            cursor: move;
        }
        .entity-header {
            padding: 8px 12px;
            color: white;
            font-weight: bold;
        }
        .entity-body {
            max-height: 250px;
            overflow-y: auto;
        }
        .entity-field {
            padding: 5px 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            font-size: 12px;
        }
        .field-name { font-weight: bold; }
        .field-type { color: #666; }
        .primary-key { color: #e74c3c; }
        .foreign-key { color: #3498db; }
        .tooltip {
            position: absolute;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-size: 12px;
            max-width: 300px;
            z-index: 1000;
            display: none;
        }
        .loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255,255,255,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            z-index: 999;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        button {
            padding: 5px 10px;
            margin-right: 5px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .error-message {
            color: red;
            font-weight: bold;
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>æ™ºèƒ½ç©¿æ­åŠ©æ‰‹æ•°æ®åº“ERå›¾</h1>
        </div>
        <div class="toolbar">
            <div>
                <button id="zoom-in">æ”¾å¤§</button>
                <button id="zoom-out">ç¼©å°</button>
                <button id="reset-view">é‡ç½®è§†å›¾</button>
                <button id="auto-layout">è‡ªåŠ¨å¸ƒå±€</button>
            </div>
            <div>
                <span>ä¸€å¯¹å¤š: <span style="color:#5470c6">â€”â€”</span></span>
                <span style="margin-left:15px">å¤šå¯¹å¤š: <span style="color:#91cc75">â€”â€”</span></span>
            </div>
        </div>
        <div class="content">
            <div id="canvas-container">
                <div id="er-canvas"></div>
            </div>
            <div id="tooltip" class="tooltip"></div>
            <div class="loading">
                <div class="spinner"></div>
                <span>åŠ è½½ä¸­...</span>
            </div>
        </div>
    </div>
    
    <!-- å…ˆåŠ è½½æ•°æ®æ–‡ä»¶ -->
    <script src="er_data.js"></script>
    
    <!-- ç„¶ååŠ è½½ä¸»è„šæœ¬ -->
    <script>
        // é”™è¯¯å¤„ç†
        window.onerror = function(message, source, lineno) {
            document.querySelector('.loading').innerHTML = 
                `<div class="error-message">
                    <p>åŠ è½½å‡ºé”™: ${message}</p>
                    <p>ä½ç½®: ${source}:${lineno}</p>
                    <button onclick="location.reload()">é‡æ–°åŠ è½½</button>
                </div>`;
            console.error('é”™è¯¯:', message, source, lineno);
            return true;
        };
        
        // å…¨å±€å˜é‡
        const canvasContainer = document.getElementById('canvas-container');
        const erCanvas = document.getElementById('er-canvas');
        const tooltip = document.getElementById('tooltip');
        
        // è§†å›¾çŠ¶æ€
        let scale = 1;
        let offsetX = 0;
        let offsetY = 0;
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let draggingEntity = null;
        let dragOffsetX = 0;
        let dragOffsetY = 0;
        
        // å®ä½“ä½ç½®
        const entityPositions = {};
        
        // ç®­å¤´æ ‡è®°SVGå®šä¹‰
        const svgns = "http://www.w3.org/2000/svg";
        const relationshipSvg = document.createElementNS(svgns, "svg");
        relationshipSvg.style.position = "absolute";
        relationshipSvg.style.width = "100%";
        relationshipSvg.style.height = "100%";
        relationshipSvg.style.pointerEvents = "none";
        relationshipSvg.style.zIndex = "-1";
        erCanvas.appendChild(relationshipSvg);
        
        // åˆå§‹åŒ–å‡½æ•°
        function init() {
            console.log("å¼€å§‹åˆå§‹åŒ–...");
            try {
                console.log(`åŠ è½½äº† ${entities.length} ä¸ªå®ä½“å’Œ ${relationships.length} ä¸ªå…³ç³»`);
                
                // è®¾ç½®ç”»å¸ƒå¤§å°
                erCanvas.style.width = "3000px";
                erCanvas.style.height = "2000px";
                
                // åˆ›å»ºå®ä½“æ¡†
                createEntities();
                
                // å¸ƒå±€å®ä½“å’Œåˆ›å»ºå…³ç³»çº¿
                autoLayout();
                
                // ç»‘å®šäº‹ä»¶
                bindEvents();
                
                // éšè—åŠ è½½ä¸­æç¤º
                document.querySelector('.loading').style.display = 'none';
                
                console.log("åˆå§‹åŒ–å®Œæˆ");
            } catch (error) {
                console.error("åˆå§‹åŒ–é”™è¯¯:", error);
                document.querySelector('.loading').innerHTML = 
                    `<div class="error-message">
                        <p>åˆå§‹åŒ–é”™è¯¯: ${error.message}</p>
                        <button onclick="location.reload()">é‡æ–°åŠ è½½</button>
                    </div>`;
            }
        }
        
        // åˆ›å»ºå®ä½“æ¡†
        function createEntities() {
            entities.forEach(entity => {
                // åˆ›å»ºå®ä½“å®¹å™¨
                const entityElement = document.createElement('div');
                entityElement.className = 'entity';
                entityElement.id = `entity-${entity.id}`;
                entityElement.dataset.id = entity.id;
                
                // åˆ›å»ºå¤´éƒ¨
                const header = document.createElement('div');
                header.className = 'entity-header';
                header.style.backgroundColor = entity.color;
                header.textContent = entity.name;
                entityElement.appendChild(header);
                
                // åˆ›å»ºå®ä½“å†…å®¹åŒº
                const body = document.createElement('div');
                body.className = 'entity-body';
                
                // æ·»åŠ å­—æ®µ
                entity.fields.forEach(field => {
                    const fieldElement = document.createElement('div');
                    fieldElement.className = 'entity-field';
                    
                    const nameElement = document.createElement('div');
                    nameElement.className = 'field-name';
                    if (field.primary_key) {
                        nameElement.classList.add('primary-key');
                        nameElement.innerHTML = field.name + ' ğŸ”‘';
                    } else if (field.foreign_key) {
                        nameElement.classList.add('foreign-key');
                        nameElement.innerHTML = field.name + ' ğŸ”—';
                    } else {
                        nameElement.textContent = field.name;
                    }
                    
                    const typeElement = document.createElement('div');
                    typeElement.className = 'field-type';
                    typeElement.textContent = field.type;
                    
                    fieldElement.appendChild(nameElement);
                    fieldElement.appendChild(typeElement);
                    body.appendChild(fieldElement);
                });
                
                entityElement.appendChild(body);
                erCanvas.appendChild(entityElement);
                
                // è®¾ç½®åˆå§‹ä½ç½®ï¼ˆéšæœºï¼Œç¨åä¼šåœ¨è‡ªåŠ¨å¸ƒå±€ä¸­è°ƒæ•´ï¼‰
                entityPositions[entity.id] = {
                    x: Math.random() * 500,
                    y: Math.random() * 500,
                    width: 220,
                    height: entityElement.offsetHeight || 200
                };
                
                // æ·»åŠ æ‹–æ‹½äº‹ä»¶
                entityElement.addEventListener('mousedown', function(e) {
                    if (e.button === 0) { // å·¦é”®ç‚¹å‡»
                        draggingEntity = entity.id;
                        const rect = entityElement.getBoundingClientRect();
                        dragOffsetX = e.clientX - rect.left;
                        dragOffsetY = e.clientY - rect.top;
                        e.stopPropagation();
                    }
                });
            });
        }
        
        // è‡ªåŠ¨å¸ƒå±€æ‰€æœ‰å®ä½“
        function autoLayout() {
            // ç®€å•çš„åˆ†å±‚å¸ƒå±€
            const itemsPerRow = 3;
            const horizontalSpacing = 300;
            const verticalSpacing = 200;
            
            entities.forEach((entity, index) => {
                const row = Math.floor(index / itemsPerRow);
                const col = index % itemsPerRow;
                
                entityPositions[entity.id] = {
                    x: col * horizontalSpacing + 50,
                    y: row * verticalSpacing + 50,
                    width: 220,
                    height: document.getElementById(`entity-${entity.id}`).offsetHeight || 200
                };
                
                updateEntityPosition(entity.id);
            });
            
            // ç»˜åˆ¶å…³ç³»çº¿
            drawRelationships();
        }
        
        // æ›´æ–°å®ä½“ä½ç½®
        function updateEntityPosition(entityId) {
            const position = entityPositions[entityId];
            const element = document.getElementById(`entity-${entityId}`);
            if (element && position) {
                element.style.transform = `translate(${position.x}px, ${position.y}px)`;
            }
        }
        
        // ç»˜åˆ¶å…³ç³»çº¿
        function drawRelationships() {
            console.log('ç»˜åˆ¶å…³ç³»çº¿å¼€å§‹...');
            // æ¸…ç©ºç°æœ‰çš„çº¿
            while (relationshipSvg.firstChild) {
                relationshipSvg.removeChild(relationshipSvg.firstChild);
            }
            
            // ç¡®ä¿SVGå®¹å™¨å¯è§ä¸”åœ¨æœ€ä¸Šå±‚ (å°è¯•)
            relationshipSvg.style.zIndex = "1";
            relationshipSvg.style.pointerEvents = "auto"; // å…è®¸äº‹ä»¶ç©¿é€ï¼Œä¾¿äºè°ƒè¯•
            
            // ä¸ºæ¯ä¸ªå…³ç³»åˆ›å»ºè¿æ¥çº¿
            relationships.forEach(rel => {
                const sourceId = rel.source;
                const targetId = rel.target;
                const source = entityPositions[sourceId];
                const target = entityPositions[targetId];
                
                if (!source || !target) {
                    console.warn(`å…³ç³» ${rel.id} çš„æºå®ä½“ ${sourceId} æˆ–ç›®æ ‡å®ä½“ ${targetId} æœªæ‰¾åˆ°ä½ç½®ä¿¡æ¯`);
                    return;
                }
                
                // è®¡ç®—è¿æ¥ç‚¹ (ç®€åŒ–ä¸ºä¸­å¿ƒç‚¹)
                const sourceX = source.x + source.width / 2;
                const sourceY = source.y + source.height / 2;
                const targetX = target.x + target.width / 2;
                const targetY = target.y + target.height / 2;
                
                console.log(`ç»˜åˆ¶å…³ç³»: ${sourceId} (${sourceX},${sourceY}) -> ${targetId} (${targetX},${targetY})`);
                
                // åˆ›å»ºç›´çº¿ (æ›¿æ¢è´å¡å°”æ›²çº¿è¿›è¡Œè°ƒè¯•)
                const line = document.createElementNS(svgns, "line");
                line.setAttribute("x1", sourceX);
                line.setAttribute("y1", sourceY);
                line.setAttribute("x2", targetX);
                line.setAttribute("y2", targetY);
                line.setAttribute("stroke", rel.color || "#888"); // é»˜è®¤ç°è‰²
                line.setAttribute("stroke-width", "2");
                
                // æ·»åŠ ç®­å¤´æ ‡è®° (å¯é€‰ï¼Œä½†æœ‰åŠ©äºè°ƒè¯•)
                line.setAttribute("marker-end", "url(#arrowhead)"); 
                
                // åˆ›å»ºæ ‡ç­¾ (ç®€åŒ–ä½ç½®)
                const midX = (sourceX + targetX) / 2;
                const midY = (sourceY + targetY) / 2;
                
                const text = document.createElementNS(svgns, "text");
                text.setAttribute("x", midX);
                text.setAttribute("y", midY - 5); // ç¨å¾®å‘ä¸Šåç§»
                text.setAttribute("text-anchor", "middle");
                text.setAttribute("font-size", "11");
                text.setAttribute("fill", "#333");
                text.textContent = rel.label || 'rel'; // æ˜¾ç¤ºæ ‡ç­¾
                
                // æ·»åŠ åˆ°SVG
                relationshipSvg.appendChild(line);
                relationshipSvg.appendChild(text);
            });
            
            // æ·»åŠ ç®­å¤´å®šä¹‰ (å¦‚æœä¹‹å‰æ²¡æœ‰)
            let defs = relationshipSvg.querySelector('defs');
            if (!defs) {
                defs = document.createElementNS(svgns, 'defs');
                relationshipSvg.insertBefore(defs, relationshipSvg.firstChild);
            }
            if (!defs.querySelector('#arrowhead')) {
                const marker = document.createElementNS(svgns, "marker");
                marker.setAttribute("id", "arrowhead");
                marker.setAttribute("markerWidth", "10");
                marker.setAttribute("markerHeight", "7");
                marker.setAttribute("refX", "10"); // è°ƒæ•´ç®­å¤´ä½ç½®ï¼Œä½¿å…¶åœ¨ç›´çº¿æœ«ç«¯
                marker.setAttribute("refY", "3.5");
                marker.setAttribute("orient", "auto");
                const polygon = document.createElementNS(svgns, "polygon");
                polygon.setAttribute("points", "0 0, 10 3.5, 0 7");
                polygon.setAttribute("fill", "#555"); // ç®­å¤´é¢œè‰²
                marker.appendChild(polygon);
                defs.appendChild(marker);
            }
            console.log('ç»˜åˆ¶å…³ç³»çº¿ç»“æŸã€‚');
        }
        
        // ç»‘å®šäº‹ä»¶å¤„ç†
        function bindEvents() {
            // é¼ æ ‡ç§»åŠ¨äº‹ä»¶
            document.addEventListener("mousemove", function(e) {
                if (draggingEntity) {
                    // æ‹–åŠ¨å®ä½“
                    const containerRect = canvasContainer.getBoundingClientRect();
                    const x = (e.clientX - containerRect.left - dragOffsetX) / scale;
                    const y = (e.clientY - containerRect.top - dragOffsetY) / scale;
                    
                    entityPositions[draggingEntity].x = x + offsetX;
                    entityPositions[draggingEntity].y = y + offsetY;
                    
                    updateEntityPosition(draggingEntity);
                    // æš‚æ—¶ç§»é™¤æ‹–åŠ¨è¿‡ç¨‹ä¸­çš„å…³ç³»çº¿æ›´æ–°
                    // drawRelationships(); 
                    
                } else if (isDragging) {
                    // æ‹–åŠ¨ç”»å¸ƒ
                    const deltaX = (e.clientX - dragStartX) / scale;
                    const deltaY = (e.clientY - dragStartY) / scale;
                    
                    offsetX -= deltaX;
                    offsetY -= deltaY;
                    
                    updateCanvasTransform();
                    
                    dragStartX = e.clientX;
                    dragStartY = e.clientY;
                }
            });
            
            // é¼ æ ‡æ¾å¼€äº‹ä»¶
            document.addEventListener("mouseup", function() {
                if (draggingEntity) {
                    // å¦‚æœåˆšåˆšç»“æŸæ‹–åŠ¨å®ä½“ï¼Œåˆ™æ›´æ–°å…³ç³»çº¿
                    drawRelationships();
                }
                draggingEntity = null;
                isDragging = false;
                canvasContainer.style.cursor = "default";
            });
            
            // ç”»å¸ƒæ‹–åŠ¨
            canvasContainer.addEventListener("mousedown", function(e) {
                if (e.button === 0 && !draggingEntity) {
                    isDragging = true;
                    dragStartX = e.clientX;
                    dragStartY = e.clientY;
                    canvasContainer.style.cursor = "grab";
                }
            });
            
            // ç¼©æ”¾æŒ‰é’®
            document.getElementById("zoom-in").addEventListener("click", function() {
                scale *= 1.2;
                updateCanvasTransform();
            });
            
            document.getElementById("zoom-out").addEventListener("click", function() {
                scale /= 1.2;
                updateCanvasTransform();
            });
            
            // é‡ç½®è§†å›¾
            document.getElementById("reset-view").addEventListener("click", function() {
                scale = 1;
                offsetX = 0;
                offsetY = 0;
                updateCanvasTransform();
            });
            
            // è‡ªåŠ¨å¸ƒå±€
            document.getElementById("auto-layout").addEventListener("click", autoLayout);
            
            // é¼ æ ‡æ»šè½®ç¼©æ”¾
            canvasContainer.addEventListener("wheel", function(e) {
                e.preventDefault();
                
                const rect = canvasContainer.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                // è®¡ç®—é¼ æ ‡åœ¨ç”»å¸ƒåæ ‡ç³»ä¸­çš„ä½ç½®
                const canvasX = mouseX / scale + offsetX;
                const canvasY = mouseY / scale + offsetY;
                
                // æ›´æ–°ç¼©æ”¾
                if (e.deltaY < 0) {
                    scale *= 1.1;
                } else {
                    scale /= 1.1;
                }
                
                // è°ƒæ•´åç§»ä»¥ä¿æŒé¼ æ ‡æŒ‡å‘çš„ç‚¹ä¸å˜
                offsetX = canvasX - mouseX / scale;
                offsetY = canvasY - mouseY / scale;
                
                updateCanvasTransform();
            });
        }
        
        // æ›´æ–°ç”»å¸ƒå˜æ¢
        function updateCanvasTransform() {
            erCanvas.style.transform = `scale(${scale}) translate(${-offsetX}px, ${-offsetY}px)`;
        }
        
        // å¯åŠ¨åˆå§‹åŒ–
        window.addEventListener("load", init);
    </script>
</body>
</html>
